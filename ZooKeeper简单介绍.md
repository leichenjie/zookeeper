# ZooKeeperz总结
## 一. 分布式协调技术
在给大家介绍ZooKeeper之前先来给大家介绍一种技术——分布式协调技术。那么什么是分布式协调技术？其实分布式协调技术主要用来解决分布式环境当中多个进程之间的同步控制，让他们有序的去访问某种临界资源，防止造成“脏数据”的后果。这时，有人可能会说这个简单，写一个调度算法就轻松解决了。说这句话的人，可能对分布式系统不是很了解，所以才会出现这种误解。如果这些进程全部是跑在一台机器上的话，相对来说确实好办了，问题就在于它是在一个分布式的环境下，这时问题又来了，那什么是分布式呢？如图1.1所示：

![1.1](images/1.1.png)  

给大家分析一下这张图，在这图中有3台机器，每台机器跑一个应用程序。然后我们将这三台机器通过网络连接起来，构成一个系统来为用户提供服务，对用户来说这个系统的架构是透明的，他感觉不到这个系统是一个什么样的架构。那么我们就可以把这个系统称作一个**分布式系统**。  
那我们接下来在分析一下，在这个分布式系统中如何对进程进行调度，我们假设在第一台机器上挂载了一个资源，然后对三个物理分布的进程都要竞争这个资源，但我们有不希望他们同时进行访问，这时候我们就需要一个**协调器**，来让他们有序的来访问这个资源。这个协调器就是我们经常提到的那个**锁**，比如说“进程-1”在使用该资源的时候，会先去获得锁，“进程-1”获得锁以后会对该资源保持独占，这样其他进程就无法访问该资源，“进程-1”用完资源后就将锁释放掉，让其他进程来获得锁，那么通过锁机制，我们就能保证分布式系统中多个进程能够有序的访问该临界资源。那么我们把这个分布式环境下的这个锁叫做**分布式锁**。
## 二. 分布式锁的实现
为了防止分布式系统中的多个进程之间相互干扰，我们需要一种分布式协调技术来对这些进程进行调度。而这个分布式协调技术的核心就是来实现这个分布式锁。
### 2.1 面临的问题
在看了图1.1所示的分布式环境之后，有人可能会感觉这不是很难。无非是将原来在同一台机器上对进城调度的原语，通过网络实现在分布式环境中。是的，表面上是可以这样说。但是问题就在网络这，在分布式系统中，所有在一台机器上的假设是不存在的：因为网络是不可靠的。  

比如，在同一台机器上，你对一个服务的调用如果成功，那就是成功，如果调用失败，比如抛出异常那就是调用失败。但是在分布式环境中，由于网络是不可靠的，你对一个服务的调用失败并不表示一定是失败的，可能是执行成功了，但是响应返回的时候失败了。还有，A和B都去调用C服务，在时间上A先调用，B后调用，那么最后结果是不是一定A的请求就先于B到达呢？这些在同一台机器上的种种假设，我们都要重新思考，我们还要思考这些问题给我们的设计和编码带来了哪些影响。还有在分布式环境中为了提高性能，我们往往会部署多套服务，但是如何在多套服务中达到一致性，这在同一台机器上多个进程之间的同步相对来说比较容易办到，但在分布式环境中确实是一个大难题。  

所以分布式协调远比在同一台机器上对多个进程的调度要难得多，而且如果为每一个分布式应用都开发一个独立的协调程序。一方面，协调程序的反复编写浪 费，且难以形成通用、伸缩性好的协调器。另一方面，协调程序开销比较大，会影响系统原有的性能。所以，急需一种高可靠、高可用的通用协调机制来用以协调分 布式应用。
### 2.2 分布式锁的实现者
目前，在分布式协调技术方面做得比较好的就是Google的Chubby还有Apache的ZooKeeper他们都是分布式锁的实现者。有人会问 既然有了Chubby为什么还要弄一个ZooKeeper，难道Chubby做得不够好吗？不是这样的，主要是Chbby是非开源的，Google自家 用。后来雅虎模仿Chubby开发出了ZooKeeper，也实现了类似的分布式锁的功能，并且将ZooKeeper作为一种开源的程序捐献给了 Apache，那么这样就可以使用ZooKeeper所提供锁服务。而且在分布式领域久经考验，它的可靠性，可用性都是经过理论和实践的验证的。所以我们 在构建一些分布式系统的时候，就可以以这类系统为起点来构建我们的系统，这将节省不少成本，而且bug也将更少。  
![2.1](images/2.1.png)  
## 三. ZooKeeper概述
ZooKeeper是一种为分布式应用所设计的高可用、高性能的一致的开源协调服务，它提供了一项基本的服务：**分布式锁服务**。由于ZooKeeper的开源特性，后来我们的开发者在分布式锁的基础上，摸索出了其他的使用方法：**配置服务、组服务、分布式消息队列、分布式通知/协调**等。  
**注意：**Zookeeper性能上的特点决定了它能够用在大型的、分布式的系统当中。从可靠性方面来说，它并不会因为一个节点的错误而崩溃。除此之外，它严格的序列访问控制意味着控制原语可以应用在客户端上。Zookeeper在一致性、可用性、容错性的保证，也是Zookeeper的成功之处，它获得的一切成功都与它采用的协议--Zab协议是密不可分的，这些内容将会在后面介绍。  
前面提到那么多的服务，比如分布式锁、配置服务、组服务等，那么他们是怎么实现的。Zookeeper在实现这些服务时，首先它设计了一种新的数据结构--Znode，然后在该数据结构的基础上定义了一些原语，也就是关于该数据结构的一些操作。有了这些数据结构和原语还不够，因为我们的Zookeeper是工作在一个分布式的环境下，我们的服务是通过消息以网络的形式发送给我们的分布式应用程序，所以我们还需要一个通知机制--watcher机制。那么总结一下，Zookeeper所提供的服务主要通过：数据结构+原语+watcher机制，三个部分实现的。
## 四. ZooKeeper数据模型
### 4.1 ZooKeeper数据模型Znode
ZooKeeper拥有一个层次的命名空间，这个和标准的文件系统非常相似，如图4.1所示  
图4.1 ZooKeeper数据模型与文件系统目录树  
![4.1](images/4.1.png)![4.2](images/4.2.png)  
从图中我们可以看到ZooKeeper的数据类型，在结构上和标准文件系统非常相似，都是采用这种树形层次结构，ZooKeeper树中的每个节点被称为--Znode。和文件系统的目录树一样，ZooKeeper树中的每个节点都可以拥有子节点。但也有不同之处：  
1. 引用方式
Znode通过路径引用，如同Unix的文件路径。路径必须是绝对的，因此他们必须由斜杠字符来开头。除此以外，他们必须是唯一的，也就是说每一个路径只有一个表示，因此这些路径不能改变。在ZooKeeper中，路径有Unicode字符串组成，并且有一些限制。字符串“/zookeeper”用以保存管理信息，比如关键配额信息。
2. Znode结构




